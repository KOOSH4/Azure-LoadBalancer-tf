# .github/workflows/terraform.yml

name: 'Terraform CI/CD with Key Vault'

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  id-token: write
  contents: read

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        
      - name: Terraform Init
        id: init
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.BACKEND_RESOURCE_GROUP_NAME }}" \
            -backend-config="storage_account_name=${{ vars.BACKEND_STORAGE_ACCOUNT_NAME }}" \
            -backend-config="container_name=${{ vars.BACKEND_CONTAINER_NAME }}" \
            -backend-config="key=loadbalancer.prod.tfstate" \
            -backend-config="use_oidc=true"

      - name: Terraform Format Check
        run: terraform fmt -check
        continue-on-error: true

      - name: Terraform Validate
        run: terraform validate

      - name: Import Existing Key Vault Secrets
        if: github.event_name == 'pull_request' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          terraform import azurerm_key_vault_secret.vm_admin_username \
            "https://kv-wss-lab-sec-001.vault.azure.net/secrets/vm-admin-username/900a65841fb44291b61f97290936c9c3" || true
          terraform import azurerm_key_vault_secret.vm_admin_password \
            "https://kv-wss-lab-sec-001.vault.azure.net/secrets/vm-admin-password/395e0f9c3a874197b563752db491ba61" || true


      - name: Terraform Plan
        id: plan
        if: github.event_name == 'pull_request'
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
          TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_client_id: ${{ secrets.AZURE_CLIENT_ID }}
          TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: false
        run: terraform plan -no-color -out=tfplan

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
          TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_client_id: ${{ secrets.AZURE_CLIENT_ID }}
          TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
        run: terraform apply -auto-approve

      - name: Display Key Vault Information
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          echo "============================================"
          echo "‚úÖ Deployment Complete!"
          echo "============================================"
          terraform output -raw instructions || echo "Unable to display instructions"
          
      - name: Retrieve and Display VM Credentials
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo ""
          echo "============================================"
          echo "üîê VM Credentials Retrieved from Key Vault"
          echo "============================================"
          
          # Get Key Vault name from Terraform output
          KV_NAME=$(terraform output -raw key_vault_name 2>/dev/null || echo "")
          
          if [ -n "$KV_NAME" ]; then
            echo "Key Vault Name: $KV_NAME"
            echo ""
            echo "Username:"
            az keyvault secret show \
              --vault-name "$KV_NAME" \
              --name vm-admin-username \
              --query value -o tsv 2>/dev/null || echo "Unable to retrieve username"
            
            echo ""
            echo "Password: [REDACTED - Available in Key Vault]"
            echo ""
            echo "To retrieve the password, run:"
            echo "az keyvault secret show --vault-name $KV_NAME --name vm-admin-password --query value -o tsv"
          else
            echo "‚ö†Ô∏è  Key Vault not yet created or output not available"
          fi
          echo "============================================"